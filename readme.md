# AeroTravel 2

- [AeroTravel](#aerotravel)
  - [Описание приложения](#описание-приложения)
  - [Файл настроек settings.yaml](#файл-настроек-settingsyaml)
  - [Аргументы запуска](#аргументы-запуска)
  - [Запуск приложения](#запуск-приложения)
  - [Шифрование паролей](#шифрование-паролей)
  - [Дешифрование паролей](#дешифрование-паролей)


## Описание приложения
Приложение AeroTravel 2 это вторая версия утилиты интеграции внутренних данных о
командировка сотрудниками с обслуживающими их тревел-агентствами.

## Файл настроек settings.yaml
Файл настроек включает в себя несколько основных обязательных секций
````markdown
settings        - Базовые настройки прокси и логов
db              - Настройки подключения к SQL-серверу приложения
smtp            - Настройки почтовой рассылки
Aeroclub        - Агентство AeroClub
CbtcTravelClick - Агентство CBTC Travel-Click
logging_config  - настройки для различных видов логирования
````
Ниже преведены основные параметры, без которых функционирование приложения невозможно
````yaml
# Блок settings отвечает за базовые настройки приложения 
settings:
  # nestleProxy - url, через который будут проксироваться запросы 
  # к агентствам по умолчанию
  nestleProxy: https://...
  
  # ip, через который будут проксироваться запросы к агентствам, 
  # если приложение запушено с параметром --system_proxy
  ProxyIp: 0.0.0.0

  # Выключение отладочных ограничений (передача по одному пользователю в каждое агентство для проверки работоспособности в целом)
  debug_limit_off: True


# Блок db содержит данные подключения к серверу базы данных
db:
  driver: SQL Server
  server: domain\server
  database: database_name

# Агентство AeroClub
AeroClub:
  devUrl: https://dev.example.com # хост для отладки
  devSourceUrl: beta-integration.aeroclub.ru # строка в неймспейсе данных
  url: https://example.com
  sourceUrl: integration.integration.aeroclub.ru # строка в неймспейсе данных
  username: username
  password: <encrypted password>
  userAgent: user-agent

  # блок companies содержит список компаний, по которым необходимо
  # подготовить выгрузку.
  companies:
    company_0:
      # Название или код компании
      id: YOUR_COMPANY 
      
      # Минимальное количество сотрудников, в выгрузке хранимой
      # процедуры, ниже которого запрос отправлен не будет
      minCounter: 1000
      
      # название хранимой процедуры для создания выгрузки
      storedProc: dbo.stored_procedure
    
# Агентство CBTC Travel-Click
CbtcTravelClick:
  url: https://example.com
  username: username
  password: <encrypted password>
  
  # Минимальное количество сотрудников, в выгрузке хранимой
  # процедуры, ниже которого запрос отправлен не будет
  minCounter: 1000 

  # Хранимая процедура для получения данных для этого агентства.
  storedProc: schema.storProcName
  
  # Логика создания нового сотрудника для агентства Тревел-Клик:
  # если у полученного из хранимки сотрудника роль holdingUserRole(sbt_manager), то
  # ему присваивается политика holdingUserPolicy(HOLDING) иначе otherUserPolicy(SELF)
  newUser:
    password: <encrypted password>
    holdingUserRole: sbt_manager
    holdingUserPolicy: HOLDING
    otherUserPolicy: SELF

  # блок companies содержит список компаний, по которым необходимо
  # подготовить выгрузку.
  companies:
    company_0:
      # Название или код компании
      id: YOUR_COMPANY 
      
      # данные сохранения сотрудников на стороне Агентства.
      # ТОчное значение неизвестно
      confirm: true
      fullUpdate: false
      incrementUpdate: true

# блок с различными настройками логирования (консольный вывод, вывод в файл и передача по почте)
logging_config: 
  ...
````
## Аргументы запуска
Запуск данного консольного приложения невозможен без передачи агрументов.

**-h** или **--help** - подробная информация по аргументам запуска.

**-a "your_agency"** или **--agency "your_agency"** - Обязательный аргумент, 
который указывает на то, по какому агентству будет совершены сбор и отправка данных.

**-p "your_agency"** или **--proxy "your_agency"** - Аргумент, который указывает на то,
через какую прокси будет идти соединение с агентством (варианты: прямое соединение, системная прокси, прокси ZSCaler).
Настройки прокси берутся из раздела settings в yaml.

**-e "your_password"** - Необязательный аргумент,
запускает подпрограмму шифрования пароля(см. раздел Шифрование паролей).

**-y "section_name"** - Необязательный аргумент, в паре с **-e** добавляет пароль в указанную секцию yaml.

**-......** - Секретный ключ, активирующий секретный набор аргументов. ;)

Данные параметры прокси берутся из файла настроек settings.yaml:
````yaml
settings:
  nestleProxy: https://proxy.com  # стандартный прокси
  ProxyIp: 0.0.0.0:8080           # альтернативный прокси
````
## Запуск приложения
Периодический запуск возможен только через Планировщик Windows. Необходимо создать
задание планировщика и как агрумент запуска -a с указанием агентства:
````markdown
C:\путь\к\приложению\AeroTravel2.exe -a "your agency"
````
## Шифрование паролей
Подпрограмма шифрования паролей доступна только в ручном режиме. Строка запуска:
````markdown
C:\путь\к\приложению\AeroTravel2.exe -e "your password"
````
Сгенерированный пароль необходимо использовать для вставки в поле password в settings.yaml

Дополнительно при использовании парамера -y можно указать секцию в yaml, куда будет вставлен зашифрованный пароль.

````markdown
C:\путь\к\приложению\AeroTravel2.exe -e "your password" -y "section_name"
````

## Дешифрование паролей
Подпрограмма дешифровки уже установленного пароля возможна при запуске секретного аргумента.
Подробная информация при запуске -h с секртным аргументом.

